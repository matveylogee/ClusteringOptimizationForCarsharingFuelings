# Clustering Optimization for Carsharing Fuelings

Проект моделирует, как умной маршрутизацией бензовозов можно уменьшить затраты каршеринга на заправку большого автопарка по городу.

Пайплайн:

1. Сначала считается **теоретический минимум** затрат на топливо в идеальных условиях (без пробега бензовозов и простоев).
2. Генерируются **синтетические данные** по Москве: АЗС, машины, их координаты и уровни топлива.
3. Строятся два простых **бейзлайна**.
4. Реализуются два более продвинутых алгоритма:
   - алгоритм на основе **Utility-метрики** и кластеризации;
   - алгоритм на основе **k-means кластеризации** машин.
5. Для каждого алгоритма строятся маршруты бензовозов и считается итоговая стоимость.

---

## 1. Постановка задачи

Имеем:

- Автопарк из $N \approx 5000$ машин.
- Каждая машина:
  - имеет координаты в городе $(\text{lat}, \text{lon})$,
  - бак объёмом **50 л**,
  - текущий уровень топлива в долях бака $X \in [0,1]$.
- Есть множество АЗС:
  - координаты $(X_s, Y_s)$,
  - цена топлива $P_s$ (руб/л).
- Для каждой АЗС есть бензовоз ёмкостью **300 л**, который:
  - стартует с этой заправки,
  - объезжает ряд машин и заправляет их *до полного бака*,
  - возвращается обратно (при необходимости делает несколько рейсов).

Цель:

> **Минимизировать суммарные денежные затраты** на заправку всего автопарка:  
> стоимость топлива + стоимость пробега бензовозов (и потенциально простои машин).

---

## 2. Теоретический минимум: «идеальные условия»

### 2.1. Модель уровня топлива

Пусть $X$ — доля бака, которая уже залита (от 0 до 1). Заправляем машину только если она «недозаправлена сильнее», чем порог 50 %:

$$
X < 0.5.
$$

Недолив в долях бака:

$$
Y = (1 - X)\,\mathbf{1}_{\{X < 0.5\}}.
$$

В литрах (бак 50 л):

$$
L = 50 \cdot Y = 50 (1 - X)\,\mathbf{1}_{\{X < 0.5\}}.
$$

Нас интересует **матожидание недолива** на одну машину:

$$
\mathbb{E}[L] = 50\,\mathbb{E}\big[(1 - X)\,\mathbf{1}_{\{X < 0.5\}}\big].
$$

Общая стоимость топлива при цене $k$ руб/л и $n$ машинах:

$$
\mathbb{E}[\text{общие затраты}] = n \cdot k \cdot \mathbb{E}[L].
$$

Таким образом, вся задача — посчитать интеграл

$$
\mathbb{E}[L] = 50 \int_0^{0.5} (1 - x)\, f_X(x)\,dx,
$$

где $f_X(x)$ — плотность распределения уровня топлива.

---

### 2.2. Эмпирическое распределение заправленности

По постановке проекта (на основе реальных данных каршеринга) доли машин по уровню бака таковы:

- $P(X < 0.1) \approx 1\%$,
- $P(0.1 \le X < 0.2) \approx 3\%$,
- $P(0.2 \le X < 0.5) \approx 20\%$,
- остальные машины заправки не требуют.

Для удобства аналитики аппроксимируем это **нормальным распределением**:

$$
X \sim \mathcal{N}(\mu, \sigma^2)
$$

и подбираем $\mu, \sigma$ так, чтобы CDF нормального распределения была максимально близка к указанным трём точкам $0.1, 0.2, 0.5$.

Численная подгонка (метод наименьших квадратов по этим трём точкам CDF) даёт:

$$
\mu \approx 0.695, \qquad \sigma \approx 0.275.
$$

По этим параметрам нормаль довольно хорошо воспроизводит исходные эмпирические доли.

---

### 2.3. Аналитическая формула для нормального $X$

Порог заправки остаётся прежний: если $X \ge 0.5$, то машину не заправляем.

Обозначим:

$$
a = \frac{0.5 - \mu}{\sigma}, \qquad
\Phi(a) = P(Z \le a), \qquad
\varphi(a) = \frac{1}{\sqrt{2\pi}} e^{-a^2/2},
$$

где $Z \sim \mathcal{N}(0,1)$ — стандартная нормаль.

Для нормального $X \sim \mathcal{N}(\mu,\sigma^2)$ можно показать, что

$$
\mathbb{E}\big[(1 - X)\,\mathbf{1}_{\{X < 0.5\}}\big]
= (1 - \mu)\Phi(a) + \sigma \varphi(a).
$$

Тогда средний недолив в литрах на одну машину:

$$
\mathbb{E}[L]
= 50 \left[ (1 - \mu)\Phi(a) + \sigma \varphi(a) \right].
$$

Подставляя $\mu \approx 0.695$, $\sigma \approx 0.275$, получаем:

$$
\mathbb{E}[L] \approx 7.9\ \text{литров на одну машину}.
$$

При цене топлива $k \approx 62$ руб/л и $n = 5000$ машин ожидаемые затраты:

- на одну машину:

  $$
  \mathbb{E}[\text{затраты на 1 машину}]
  \approx k \cdot \mathbb{E}[L]
  \approx 62 \cdot 7.9 \approx 490\ \text{руб};
  $$

- на весь парк:

  $$
  \mathbb{E}[\text{общие затраты}]
  \approx n \cdot k \cdot \mathbb{E}[L]
  \approx 5000 \cdot 62 \cdot 7.9
  \approx 2.45\text{–}2.55\ \text{млн руб}.
  $$

Это — **теоретический нижний предел**: здесь не учитывается пробег бензовозов и время, в течение которого машины простаивают незаправленными.

---

## 3. Генерация синтетических данных

### 3.1. Город и АЗС

- Город — Москва, центр — координаты около Кремля.
- АЗС берутся из файла (например, `moscow_stations.csv`):
  - координаты,
  - цена топлива $P_s$.
- На графиках используются окружности (Садовое, ТТК, МКАД) для лучшего визуального понимания.

### 3.2. Радиальное β-распределение машин

Распределение машин моделируется **радиальным β-распределением**:

1. Радиус $r$ генерируется из β-распределения на отрезке $[0, R_{\max}]$.
2. Угол $\theta$ — равномерно на $[0, 2\pi)$.
3. Далее $(r, \theta)$ переводятся в $(\text{lat}, \text{lon})$.

Так получается реалистичная «куча» машин вокруг центра.

### 3.3. Утро и вечер

Моделируются два сценария:

- **утро** — больше машин ближе к центру (люди едут на работу);
- **вечер** — больше машин на периферии и в спальных районах.

В ноутбуках получаются два датафрейма:

- `df_morning` — распределение машин утром;
- `df_evening` — распределение вечером.

### 3.4. Уровни заправленности

Уровень топлива $X$ генерируется в соответствии с моделью из раздела 2:

- целимся в нормальное распределение с $\mu \approx 0.695$, $\sigma \approx 0.275$,
- при этом выдерживаются указанные эмпирические доли:
  - < 10 % — 1 % парка,
  - 10–20 % — 3 %,
  - 20–50 % — 20 %,
  - остальные машины считаются полными и не требуют заправки.

---

## 4. Бейзлайны

Реализованы в ноутбуке `baselines.ipynb`. Задача бейзлайнов — получить простые, но честные ориентиры сверху.

### 4.1. Метрика стоимости

Итоговая стоимость для любого алгоритма считается по схеме:

$$
\text{TotalCost} =
\underbrace{\sum_{j} P_{s(j)} \cdot D_j}_{\text{стоимость топлива}}
+
\underbrace{c_{\text{dist}} \cdot \sum_{\text{рейсы}} \text{длина маршрута}}_{\text{стоимость пробега}} ,
$$

где:

- $D_j$ — недозаправленность машины $j$ в литрах,
- $P_{s(j)}$ — цена топлива на выбранной для неё АЗС,
- $c_{\text{dist}}$ — стоимость 1 км пробега бензовоза (из расхода топлива и цены за литр),
- длина маршрута измеряется в километрах (манхэттенская метрика по плоскости).

### 4.2. Бейзлайн 1 — ближайшая заправка

Для каждой машины выбираем **самую близкую** АЗС по расстоянию (цена топлива игнорируется). Получаем:

- минимальный пробег бензовозов,
- не всегда выгодные цены топлива.

Итоговая стоимость для 5000 машин — порядка **2.75 млн руб**.

### 4.3. Бейзлайн 2 — самые дешёвые заправки

Берём набор **самых дешёвых** АЗС (например, несколько штук с минимальной ценой) и пытаемся заправить весь парк только с них.

- топливо дешевле,
- но пробеги бензовозов сильно растут.

Итоговая стоимость — порядка **2.9 млн руб**, то есть хуже, чем у «ближайших» АЗС.

---

## 5. Алгоритм 1: Utility-метрика и кластеризация

Реализован в `utility.ipynb`.

Идея: сначала построить «разумную» метрику полезности пары «станция–машина», а потом на её основе распределить машины по станциям и построить маршруты.

### 5.1. Скор, стоимость и Utility

Для каждой пары $(s, j)$ (станция $s$, машина $j$) считаем:

- недозаправленность $D_j$ (л),
- расстояние $d_{s j}$ от станции до машины (км, манхэттен).

**Скор**:

$$
\text{score}_{s j} = \frac{D_j}{P_s} \cdot f_{\text{dist}}(d_{s j}),
$$

где $f_{\text{dist}}(d)$ — убывающая функция расстояния, например:

- степенная:

  $$
  f_{\text{dist}}^{\text{power}}(d) = \frac{1}{(d + \varepsilon)^p},
  $$

- экспоненциальная:

  $$
  f_{\text{dist}}^{\exp}(d) = e^{-\gamma d}.
  $$

**Стоимость пары**:

$$
\text{Cost}_{s j}
= P_s \cdot D_j + c_{\text{dist}} \cdot d_{s j}.
$$

Далее нормируем:

- $\text{score\_norm}_{s j}$ — нормированный скор,
- $\text{cost\_norm}_{s j}$ — нормированная стоимость.

И объединяем их в **Utility**:

$$
\text{Utility}_{s j}
=
\tilde{w}_{\text{score}} \cdot \text{score\_norm}_{s j}
+
\tilde{w}_{\text{cost}} \cdot \bigl(1 - \text{cost\_norm}_{s j}\bigr).
$$

Здесь $\text{score\_norm}_{s j}$ и $\text{cost\_norm}_{s j}$ — предварительно приведены к диапазону $[0,1]$, а веса удовлетворяют

$$
\tilde{w}_{\text{score}} + \tilde{w}_{\text{cost}} = 1.
$$

Чем выше $\text{Utility}_{s j}$, тем выгоднее заправлять машину $j$ с заправки $s$.

---

### 5.2. Назначение машин станциям

По матрице Utility:

1. Для каждой машины $j$ находим станцию с максимальной Utility.
2. Группируем машины по станциям и получаем кластеры вида:

   > «АЗС $s$ → множество машин, которые она обслуживает».

В модели один такой кластер обычно соответствует одному бензовозу (или нескольким рейсам этого бензовоза с учётом ёмкости 300 л).

---

### 5.3. Маршрутизация бензовоза внутри кластера

Для каждого кластера:

- если в кластере мало машин (например, $n < 10$), используем **алгоритм Хелда–Карпа** для точного решения задачи коммивояжёра (TSP) с возвратом на станцию;
- если машин много, используем **жадный маршрут**:
  - выбираем следующую машину по комбинации «близко и сильно недозаправлена»,
  - следим за ограничением 300 л,
  - как только объём загруженного топлива исчерпан — возвращаемся на АЗС и при необходимости стартуем новый рейс.

Во всех шагах расстояние считается в километрах, манхэттенской метрикой.

Получаем суммарную длину маршрутов и пробеговую составляющую стоимости.

---

### 5.4. Итоговая стоимость (Utility-алгоритм)

Итоговая стоимость:

$$
\text{TotalCost}^{\text{Utility}}
=
\sum_j P_{s(j)} D_j
+
c_{\text{dist}} \sum_{\text{рейсы}} \text{длина маршрутов}.
$$

На экспериментальных данных (5000 машин, синтетическое распределение) Utility-алгоритм даёт стоимость порядка **2.70 млн руб**, что лучше обоих бейзлайнов, но хуже k-means-подхода.

---

## 6. Алгоритм 2: k-means-кластеризация и выбор заправок

Реализован в `kmeansClusters.ipynb`.

### 6.1. Идея

Здесь мы сначала **кластеризуем машины по географии**, а уже потом выбираем для каждого кластера оптимальную АЗС. Недозаправленность внутри кластера предполагается «плюс-минус одинаковой».

### 6.2. Кластеризация машин

1. Выбираем целевой размер кластера (например, 5–6 машин), чтобы суммарный недолив не превышал сильно ёмкость бензовоза 300 л.
2. Считаем число кластеров:

   $$
   n_{\text{clusters}} \approx \frac{N}{K_{\text{target}}}.
   $$

3. Запускаем `KMeans` по координатам `(lat, lon)`:
   - получаем `cluster_id` для каждой машины,
   - и центры кластеров $(\text{center\_lat}, \text{center\_lon})$.

---

### 6.3. Стоимость кластера от станции

Пусть $C$ — кластер, $s$ — АЗС. Обозначим:

- суммарный недолив в кластере:

  $$
  \sum_{j\in C} D_j,
  $$

- расстояние от центра кластера до АЗС:

  $$
  d(C, s) = d\bigl(\text{center}(C), s\bigr)
  $$

  (манхэттенская метрика в км).

Тогда стоимость обслужить кластер $C$ с АЗС $s$:

$$
f(C, s)
=
P_s \cdot \sum_{j\in C} D_j
+
c_{\text{dist}} \cdot d(C, s).
$$

Для каждого кластера перебираем все станции и выбираем

$$
s^*(C) = \arg\min_s f(C, s).
$$

---

### 6.4. Маршрут в пределах кластера

В простейшей версии маршрута стоимость пробега для кластера оценивается как:

- «станция $s^*(C)$ → центр кластера → станция $s^*(C)$»,

либо:

- строится сокращённый TSP по конкретным машинам кластера, аналогично Utility-ноутбуку.

Длина маршрута суммируется по всем кластерам и умножается на $c_{\text{dist}}$.

---

### 6.5. Итоговая стоимость (k-means-подход)

Итоговая стоимость:

$$
\text{TotalCost}^{\text{k-means}}
=
\sum_C P_{s^*(C)} \sum_{j\in C} D_j
+
c_{\text{dist}} \sum_C \text{route\_length}(C).
$$

На тех же синтетических данных k-means-подход даёт стоимость порядка **2.61 млн руб**, что:

- ближе всего к теоретическому минимуму (~2.5 млн),
- лучше Utility-алгоритма,
- лучше обеих бейзлайнов.

---

## 7. Количество бензовозов

В текущей постановке:

- **один кластер ≈ один бензовозный маршрут**;
- если кластер привязан к АЗС $s$, можно считать, что у этой АЗС есть свой бензовоз, обслуживающий данный маршрут.

Таким образом, количество бензовозов приблизительно равно количеству активных кластеров.

В реальной жизни это число, конечно, ограничено, и задача превращается в более общий VRP с ограниченным количеством машин — это одно из направлений развития проекта.

---

## 8. Структура репозитория

Примерная структура:

```text
.
├── data/
│   ├── moscow_stations.csv        # координаты и цены АЗС
│   └── ...                        # дополнительные данные, кеши
├── notebooks/
│   ├── baselines.ipynb            # генерация данных + два бейзлайна
│   ├── utility.ipynb              # Utility-метрика, назначение машин, маршруты
│   ├── kmeansClusters.ipynb       # k-means кластеризация, выбор АЗС
│   ├── baseline_4.ipynb           # дополнительный baseline с детальной метрикой
│   └── ...
├── docs/
│   └── Презентация защиты.pdf     # презентация проекта
└── README.md                      # этот файл
```

---

## 9. Как запустить

1. Установить зависимости (пример):

   ```bash
   pip install numpy pandas matplotlib plotly scikit-learn scikit-optimize
   ```

2. Запустить Jupyter / VS Code и открыть ноутбуки по очереди:

   - `baselines.ipynb` — сгенерировать данные и посмотреть бейзлайны.
   - `utility.ipynb` — построить Utility-матрицу, назначить машины станциям, построить маршруты, посчитать `TotalCost`.
   - `kmeansClusters.ipynb` — сделать k-means кластеризацию, выбрать АЗС для кластеров, посчитать `TotalCost`.

3. Сравнить значения `TotalCost`:

   - с теоретическим минимумом (~2.5 млн),
   - между бейзлайнами,
   - Utility-алгоритмом,
   - k-means-алгоритмом.

---

## 10. Дальнейшее развитие

Идеи для следующих итераций проекта:

- Ограничить **реальное число бензовозов** и решать multi-depot capacitated VRP.
- Учитывать **простои машин** (время ожидания заправки) напрямую в целевой функции.
- Использовать **реальные данные** автопарка и реальную дорожную сеть (через API маршрутов).
- Расширить модель на другие города.
- Улучшить k-means-кластеризацию (например, использовать density-aware подходы, адаптивный размер кластеров и т.п.).
