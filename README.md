# Clustering Optimization for Carsharing Fuelings

Этот проект — экспериментальное исследование, как **умной маршрутизацией бензовозов** можно уменьшить затраты каршеринга на заправку автопарка по городу.

Мы:

1. Сначала считаем **теоретический минимум** затрат на топливо в идеальных условиях (без пробега бензовозов и простоев машин).
2. Генерируем **синтетический город**: координаты машин и реальные АЗС в Москве, утреннее и вечернее распределение парка, уровни топлива в баках.
3. Строим два «глупых» бейзлайна.
4. Реализуем два более продвинутых алгоритма:
   - алгоритм на основе **Utility-метрики и кластеризации**;
   - алгоритм на основе **k-means кластеризации** и оценки стоимости обслуживания кластера.
5. Строим маршруты бензовозов по кластерам (частично решая TSP/VRP) и считаем итоговые метрики.

Сравниваются итоговые стоимости с теоретическим минимумом и бейзлайнами.  
По результатам симуляции k-means-алгоритм даёт наилучшую стоимость, ближе всего к теоретическому минимуму.

---

## 1. Постановка задачи

Есть:

- Автопарк каршеринга, **N ≈ 5000 машин**.
- Каждая машина:
  - имеет координаты в городе (широта, долгота),
  - бак **50 л**,
  - текущий уровень топлива в долях бака \(X in [0, 1]\).
- Есть множество **АЗС**:
  - координаты,
  - цена топлива \(P_s\) (руб/л).
- Для каждой АЗС доступен **бензовоз ёмкостью 300 л**, который:
  - выезжает с заправки,
  - объезжает ряд машин и заправляет их до полного бака,
  - возвращается обратно (допускается несколько рейсов).

Нужно:

> **Минимизировать суммарные денежные затраты** на заправку автопарка:  
> стоимость топлива + пробег бензовозов (и, при расширении, простои машин).

---

## 2. Теоретический минимум: «идеальные условия»

### 2.1. Модель уровня топлива

Пусть \(X\) — доля бака, которая уже залита (от 0 до 1). Заправляем машину только если она «недозаправлена сильнее», чем порог 50 %:

** заправляем, если X < 0.5 **

Недолив в долях бака:

**Y = (1 - X)\, \mathbf{1}_{\{X < 0.5\}}**

В литрах (бак 50 л):

\[
L = 50 \cdot Y = 50 (1 - X)\, \mathbf{1}_{\{X < 0.5\}}
\]

Нас интересует **матожидание недолива** на одну машину:

\[
\mathbb{E}[L] = 50\, \mathbb{E}\big[ (1 - X)\, \mathbf{1}_{\{X < 0.5\}} \big].
\]

Общая стоимость топлива при цене \(k\) руб/л и \(n\) машинах:

\[
\mathbb{E}[\text{общие затраты}] = n \cdot k \cdot \mathbb{E}[L].
\]

Таким образом, вся задача — посчитать интеграл

\[
\mathbb{E}[L] = 50 \int_0^{0.5} (1 - x) f_X(x)\, dx,
\]

где \(f_X\) — плотность распределения уровня топлива. :contentReference[oaicite:1]{index=1}  

### 2.2. Эмпирическое распределение заправленности

По постановке проекта и данным каршеринга:

- < 10 % бака — **1 % парка**;
- 10–20 % бака — **3 % парка**;
- 20–50 % бака — **20 % парка**;
- остальные машины заправки не требуют. :contentReference[oaicite:2]{index=2}  

Чтобы удобно считать интеграл, аппроксимируем \(X\) **нормальным распределением**:

\[
X \sim \mathcal{N}(\mu, \sigma^2)
\]

и подбираем \(\mu\) и \(\sigma\) так, чтобы CDF нормального распределения максимально хорошо воспроизвела три эмпирические точки:

\[
P(X < 0.1) \approx 0.01, \quad
P(X < 0.2) \approx 0.04, \quad
P(X < 0.5) \approx 0.24.
\]

Численная подгонка (метод наименьших квадратов по этим точкам) даёт:

\[
\mu \approx 0.695,\quad \sigma \approx 0.275.
\]

Эта нормаль довольно хорошо согласуется с эмпирическими долями. :contentReference[oaicite:3]{index=3}  

### 2.3. Аналитическая формула для нормального X

Порог заправки тот же: \(X \ge 0.5\) — не заправляем.

Обозначим:

\[
a = \frac{0.5 - \mu}{\sigma},\quad
\Phi(a) = P(Z \le a),\quad
\varphi(a) = \frac{1}{\sqrt{2\pi}} e^{-a^2/2},
\]

где \(Z \sim \mathcal{N}(0,1)\) — стандартная нормаль.

Для нормального \(X \sim \mathcal{N}(\mu,\sigma^2)\) можно показать, что

\[
\mathbb{E}\big[(1 - X)\mathbf{1}_{\{X < 0.5\}}\big]
= (1 - \mu)\Phi(a) + \sigma \varphi(a).
\]

Тогда **средний недолив в литрах** на одну машину:

\[
\mathbb{E}[L]
= 50 \left[ (1 - \mu)\Phi(a) + \sigma \varphi(a) \right].
\]

Подставляя \(\mu \approx 0.695\), \(\sigma \approx 0.275\), получаем

\[
\mathbb{E}[L] \approx 7.9\ \text{литров на машину}.
\]

При цене \(k \approx 62\) руб/л и \(n = 5000\) машин:

- Средние затраты на одну машину:

  \[
  \mathbb{E}[\text{затраты на 1 машину}]
  \approx 62 \cdot 7.9 \approx 490\ \text{руб}.
  \]

- Ожидаемая **минимальная** сумма для заправки всего парка:

  \[
  \mathbb{E}[\text{общие затраты}]
  \approx 5000 \cdot 62 \cdot 7.9
  \approx 2.45\ \text{млн руб}.
  \]

На слайдах проект фиксирует этот минимум как **≈ 2.45–2.55 млн руб**. :contentReference[oaicite:4]{index=4}  

> Это нижняя теоретическая граница: здесь мы **не учитываем** ни пробег бензовозов, ни пробки, ни простои машин.

---

## 3. Генерация синтетических данных

### 3.1. Город и АЗС

- Город — **Москва**, центр — примерно координаты Кремля.
- Используются реальные АЗС (например, из `moscow_stations.csv`): у каждой есть координаты и цена топлива.
- На карте рисуются кольца (Садовое, ТТК, МКАД), чтобы видеть структуру города. :contentReference[oaicite:5]{index=5}  

### 3.2. Радиальное β-распределение машин

Распределение машин моделируется как **радиальное β-распределение**:

- радиус \(r\) генерируется из β-распределения на отрезке \([0, R_{\max}]\),
- угол \(\theta\) — равномерно на \([0, 2\pi)\),
- затем радиус и угол переводятся в координаты (lat, lon).

Так получаем реалистичную «кучу» машин вокруг центра.

### 3.3. Утро и вечер

Чтобы смоделировать разные режимы города:

- **утро**: плотность машин выше **ближе к центру** (люди едут на работу);  
- **вечер**: распределение сдвигается к **спальным районам**, больше машин на периферии. :contentReference[oaicite:6]{index=6}  

В ноутбуке `baselines.ipynb` генерируются два датафрейма:

- `df_morning` — распределение машин утром;
- `df_evening` — распределение вечером.

На слайдах (стр. 8) показаны карты утро/вечер с АЗС и кольцами.

### 3.4. Уровень заправленности

Уровень топлива каждой машины \(X\) генерируется согласно модели из раздела 2:

- целимся в нормальное распределение с параметрами \(\mu \approx 0.695\), \(\sigma \approx 0.275\),
- при этом сохраняем эмпирические доли:
  - < 10 % — 1 % парка,
  - 10–20 % — 3 %,
  - 20–50 % — 20 %,
  - остальные — не требуют заправки. :contentReference[oaicite:7]{index=7}  

---

## 4. Бейзлайны

Реализованы в ноутбуке `baselines.ipynb`. Цель — получить простые ориентиры «сверху» для итоговой стоимости.

### 4.1. Метрика стоимости

Для обеих стратегий итоговая стоимость считается одинаково:

\[
\text{TotalCost}
= \sum_{\text{машины}} P_{s(j)} \cdot D_j
+ \sum_{\text{рейсы}} c_{\text{dist}} \cdot \text{длина маршрута},
\]

где  
\(D_j\) — недозаправленность машины \(j\) в литрах;  
\(P_{s(j)}\) — цена топлива на выбранной для неё АЗС;  
\(c_{\text{dist}}\) — стоимость 1 км пробега бензовоза, оцениваемая из его расхода и средней цены топлива;  
длина маршрута измеряется в **манхэттенских километрах**.

### 4.2. Бейзлайн 1: ближайшая заправка

Идея:

- Для каждой машины выбираем **самую ближайшую по расстоянию** АЗС.
- Цена топлива не учитывается.
- Бензовозы обслуживают машины «по месту», зато проезжают минимальное расстояние.

Результат (для 5000 машин, усреднённо):

> **≈ 2 752 812 руб.** на автопарк. :contentReference[oaicite:8]{index=8}  

### 4.3. Бейзлайн 2: самые дешёвые заправки

Идея:

- Берём набор **самых дешёвых АЗС** (например, k штук).
- Используем только их: все машины тянем к этим станциям.
- Итог — дешёвое топливо, но длинные маршруты бензовозов.

Результат:

> **≈ 2 899 304 руб.** — хуже первого бейзлайна из-за большой длины маршрутов. :contentReference[oaicite:9]{index=9}  

---

## 5. Алгоритм 1: Utility-метрика + кластеризация

Реализован в ноутбуке `utility.ipynb`.

### 5.1. Матрица «станция–машина»

Для каждой пары станция–машина \( (s, j) \) считаем:

1. **Недозаправленность** машины \(D_j\) (в литрах).
2. **Расстояние** \(d_{s j}\) от станции до машины в км:
   - манхэттенская метрика по плоскости (перевод из координат в км).
3. **Сырой скор**:

\[
\text{score}_{s j}
= \frac{D_j}{P_s} \cdot f_{\text{dist}}(d_{s j}),
\]

где \(f_{\text{dist}}(d)\) — убывающая функция расстояния, например:

- степенная:

  \[
  f_{\text{dist}}(d) = \frac{1}{(d + \varepsilon)^p},
  \]

- экспоненциальная:

  \[
  f_{\text{dist}}(d) = e^{-\gamma d}.
  \]

4. **Стоимость** пары:

\[
\text{Cost}_{s j}
= P_s \cdot D_j + c_{\text{dist}} \cdot d_{s j}.
\]

### 5.2. Нормировка и Utility

Чтобы совместить пользу и стоимость в одной шкале, нормируем:

- `score_norm_{s j}` — нормированный скор по столбцу (по станциям для каждой машины),
- `cost_norm_{s j}` — нормированная стоимость.

Итоговая метрика:

\[
\text{Utility}_{s j}
= \tilde{w}_{\text{score}} \cdot \text{score\_norm}_{s j}
+ \tilde{w}_{\text{cost}} \cdot (1 - \text{cost\_norm}_{s j}),
\]

где \(\tilde{w}_{\text{score}}, \tilde{w}_{\text{cost}}\) — веса (в сумме = 1).

Интерпретация:  
**чем больше Utility, тем выгоднее обслуживать машину \(j\) с заправки \(s\)**.

### 5.3. Назначение машин станциям

По матрице Utility:

- для каждой машины \(j\) выбираем станцию с максимальной Utility;
- группируем машины по выбранной станции:
  - получаем кластеры вида «станция → набор машин»;
  - по сути, **один кластер = один бензовозный маршрут** (или несколько рейсов от этой АЗС при ограничении 300 л).

### 5.4. Маршрутизация бензовоза внутри кластера

Для каждого кластера:

1. Если машин **мало (n < 12)** — используем **алгоритм Хелда–Карпа**, чтобы найти оптимальный маршрут (TSP) с возвращением на станцию. :contentReference[oaicite:10]{index=10}  
2. Если машин много — используем **жадный алгоритм**:
   - сначала сортируем машины по недозаправленности (заправляем самые пустые),
   - затем двигаемся к ближайшей ещё не обслуженной машине, пока не кончится вместимость 300 л,
   - возвращаемся на станцию, стартуем следующий рейс, если в кластере ещё остались машины.

Расстояние между точками — **манхэттенское**; это отражено и в презентации. :contentReference[oaicite:11]{index=11}  

Итоговый маршрут → длина в км → стоимость пробега → вклад в `TotalCost`.

### 5.5. Итоговая стоимость и результат

Итоговая стоимость:

\[
\text{TotalCost}
= \underbrace{\sum P_s D_j}_{\text{топливо}}
+ \underbrace{c_{\text{dist}} \sum \text{длина маршрутов}}_{\text{пробег}}
\quad (+\ \text{возможные простои}).
\]

По результатам моделирования для 5000 машин:

> **Utility-алгоритм ≈ 2 699 227 руб.**  
> Это лучше ближайшего бейзлайна (~2.75 млн), но хуже k-means-подхода. :contentReference[oaicite:12]{index=12}  

---

## 6. Алгоритм 2: k-means-кластеризация + выбор заправок

Реализован в ноутбуке `kmeansClusters.ipynb`.

### 6.1. Основная идея

Упрощение:

> **Считаем, что все машины кластера имеют примерно одинаковую недозаправленность.**

Тогда достаточно разделить парк на компактные кластеры по географии, а затем для каждого кластера выбрать оптимальную АЗС.

Алгоритм состоит из двух этапов:

1. **Кластеризация машин** по координатам.
2. **Определение оптимальной заправки** для каждого кластера по специальной метрике.

### 6.2. Кластеризация машин

- Выбираем целевой размер кластера, например **K ≈ 5–6 машин**,
  чтобы их общий недолив не превышал ёмкость бензовоза 300 л (при баке 50 л).
- Считаем число кластеров: `n_clusters ≈ N / K`.
- Запускаем `KMeans` (`sklearn.cluster.KMeans`) по признакам (lat, lon).
- Для каждой машины получаем `cluster_id`, а для каждого кластера — **центр** (средние координаты).

> В модели один кластер ≈ один рейс бензовоза.  

На слайде «Кластеризация» показана карта кластеров и АЗС. :contentReference[oaicite:13]{index=13}  

### 6.3. Метрика между кластером и заправкой

Пусть:

- \(C\) — кластер,
- \(s\) — АЗС,
- \(\sum_{j\in C} D_j\) — суммарная недозаправленность в кластере,
- \(d(\text{center}(C), s)\) — расстояние от центра кластера до станции (в км, манхэттен).

Тогда стоимость обслужить кластер \(C\) с АЗС \(s\) оценивается как:

\[
f(C, s)
= P_s \cdot \sum_{j\in C} D_j
+ c_{\text{dist}} \cdot d(\text{center}(C), s).
\]

Интерпретация:

- **первое слагаемое** — стоимость топлива для всех машин кластера,
- **второе слагаемое** — стоимость выезда бензовоза к кластеру и возврата (или приближённая стоимость маршрута).

Для каждого кластера перебираем все станции и выбираем \(s^\*\) с минимальным \(f(C, s)\).

### 6.4. Маршрут внутри кластера

В k-means-ноутбуке маршрут может:

- либо приближённо оцениваться через длину «станция → центр кластера → станция»,
- либо строиться более подробно (по аналогии с Utility-подходом), если мы используем реальный TSP/жадные маршруты внутри кластера.

В любом случае, суммарная длина маршрутов по всем кластерам учитывается в метрике `TotalCost`.

### 6.5. Результат

Для 5000 машин на выборке:

> **k-means-алгоритм ≈ 2 608 866 руб.** — лучше Utility-подхода и бейзлайнов. :contentReference[oaicite:14]{index=14}  

Сводная таблица (со слайда «Сравнение метрик»):

| Метод                | Ожидаемая стоимость, руб |
|----------------------|--------------------------|
| Теоретический минимум | ≈ 2 550 000             |
| **k-means**          | ≈ 2 608 866             |
| Utility              | ≈ 2 699 227             |
| Бейзлайн (ближайшие) | ≈ 2 752 812             | :contentReference[oaicite:15]{index=15}  

Экономия относительно лучшего бейзлайна достигает **≈ 140 тыс. руб.** на автопарк из 5000 машин.

---

## 7. Количество бензовозов и распределение кластеров по заправкам

В текущей модели:

- **один кластер = один бензовозный маршрут**;
- если кластер привязан к АЗС \(s\), то можно считать, что **у этой станции есть свой бензовоз**, который выезжает на этот маршрут.

На практике это означает:

- количество бензовозов ≈ количество активных кластеров;
- на слайде «Распределение кластеров по заправкам» видно, что в эксперименте получилось **143 различных АЗС**, а значит, **143 бензовоза**, что нереалистично для реального города. :contentReference[oaicite:16]{index=16}  

Это сознательно оставлено как направление для будущей работы:  

> *«Цель на будущее — использовать меньше бензовозов, что приближено к реальной жизни, и распараллелить их работу.»* :contentReference[oaicite:17]{index=17}  

---

## 8. Структура проекта

Примерная структура репозитория:

```text
.
├── data/
│   ├── moscow_stations.csv        # АЗС и цены топлива
│   └── ...                        # дополнительные файлы/кеши
├── notebooks/
│   ├── baselines.ipynb            # генерация данных + глупые бейзлайны
│   ├── utility.ipynb              # Utility-метрика, кластеризация и маршруты
│   ├── kmeansClusters.ipynb       # k-means кластеризация кластеров + выбор АЗС
│   ├── baseline_4.ipynb           # дополнительный baseline c подробной метрикой
│   └── ...                        # вспомогательные исследования
├── docs/
│   └── Презентация защиты.pdf     # презентация проекта
└── README.md                      # данный файл
